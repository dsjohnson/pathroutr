<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Re-routing Harbor Seal Movement Tracks Around Land with {pathroutr} • pathroutr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Re-routing Harbor Seal Movement Tracks Around Land with {pathroutr}">
<meta property="og:description" content="pathroutr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pathroutr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/akharborseal_demo.html">Re-routing Harbor Seal Movement Tracks Around Land with {pathroutr}</a>
    </li>
    <li>
      <a href="../articles/reroute_demo.html">Re-routing Straight Line Paths Around Barriers - A Visibility Graph Demo</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="akharborseal_demo_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="akharborseal_demo_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="akharborseal_demo_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Re-routing Harbor Seal Movement Tracks Around Land with {pathroutr}</h1>
            
      
      
      <div class="hidden name"><code>akharborseal_demo.Rmd</code></div>

    </div>

    
    
<div id="alaska-harbor-seal-example" class="section level2">
<h2 class="hasAnchor">
<a href="#alaska-harbor-seal-example" class="anchor"></a>Alaska Harbor Seal Example</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">pathroutr</span><span class="op">)</span>
<span class="co">#devtools::load_all(here::here())</span></code></pre></div>
</div>
<div id="essential-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#essential-packages" class="anchor"></a>Essential Packages</h2>
<p>This example relies on two non-release packages of <a href="https://docs.ropensci.org/stplanr">stplanr</a> and <code>{crawl}</code></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># not run</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://remotes.r-lib.org">remotes</a></span><span class="op">)</span>
<span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">'NMML/crawl@devel'</span><span class="op">)</span>
<span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">'ropensci/stplanr'</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">crawl</span><span class="op">)</span>
<span class="co">#&gt; crawl 2.2.3 (2019-04-30) </span>
<span class="co">#&gt;  Demos and documentation can be found at our new GitHub repository:</span>
<span class="co">#&gt;  https://dsjohnson.github.io/crawl_examples/</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/stplanr">stplanr</a></span><span class="op">)</span></code></pre></div>
<p>Additional packages we’ll want to load</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="co">#&gt; Linking to GEOS 3.8.1, GDAL 3.1.1, PROJ 6.3.1</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/ggspatial">ggspatial</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></code></pre></div>
<p>The purpose of this is to demonstrate a more ‘real world’ use of <code>{pathroutr}</code> for re-routing of marine animal movement around land features. Here, we will use the Alaska harbor seal data provided in the <code>{crawl}</code> package to:</p>
<ol style="list-style-type: decimal">
<li>demonstrate and data wrangling and pre-processing needed</li>
<li>use <code>{crawl</code>}’s movement model to predict the most likely path</li>
<li>re-route the predicted path around any land barriers</li>
<li>repeat the process but using <code>{crawl}</code>’s multiple imputation functionality to create a set of possible predicted paths that span model uncertainty</li>
</ol>
</div>
<div id="pre-processing-track-data-and-land-polygon-data" class="section level2">
<h2 class="hasAnchor">
<a href="#pre-processing-track-data-and-land-polygon-data" class="anchor"></a>Pre-processing Track Data and Land Polygon Data</h2>
<p>For our land data, we will source in the Alaska 1:250000 coastal data polygon. This is provided by the Alaska Department of Natural Resources and was obtained from their open data portal (<a href="https://gis.data.alaska.gov/datasets/alaska-1250000" class="uri">https://gis.data.alaska.gov/datasets/alaska-1250000</a>). The commented code provides a query to pull the data directly from the portal API. Note, only those polygons that intersect with the bounding box of our harbor seal movement are included.</p>
<p>NOTE: because this step is time consuming, we will load directly from package data</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># akcoast_qry &lt;- "https://arcgis.dnr.alaska.gov/arcgis/rest/services/OpenData/Physical_AlaskaCoast/MapServer/2/query?where=1%3D1&amp;outFields=*&amp;geometry=-159.240%2C55.112%2C-152.422%2C59.413&amp;geometryType=esriGeometryEnvelope&amp;inSR=4326&amp;spatialRel=esriSpatialRelIntersects&amp;outSR=3338&amp;f=json"</span>
<span class="co"># </span>
<span class="co"># akcoast &lt;- sf::read_sf(akcoast_qry)</span>
<span class="co"># akcoast &lt;- sf::st_make_valid(akcoast)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"akcoast"</span><span class="op">)</span></code></pre></div>
<p>Now, let’s load in our harbor seal data from the <code>{crawl}</code> package. The <code>harborSeal_sf</code> data is only available in the <em>devel</em> branch. We also transform to EPSG:3338.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"harborSeal_sf"</span><span class="op">)</span>

<span class="va">harborSeal_sf</span> <span class="op">&lt;-</span> <span class="va">harborSeal_sf</span> <span class="op">%&gt;%</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">3338</span><span class="op">)</span></code></pre></div>
<p>Let’s plot things to make sure everything looks good. The <code>harborSeal_sf</code> data has missing values in the <em>geometry</em> field so we need to filter those out when making a line.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">l</span> <span class="op">&lt;-</span> <span class="va">harborSeal_sf</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_query.html">st_is_empty</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>do_union <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="st">'LINESTRING'</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">annotation_spatial</a></span><span class="op">(</span><span class="va">akcoast</span>, fill <span class="op">=</span> <span class="st">"cornsilk3"</span>, size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">l</span>, color <span class="op">=</span> <span class="st">"darkgrey"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">harborSeal_sf</span>, color <span class="op">=</span> <span class="st">"deepskyblue3"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="akharborseal_demo_files/figure-html/unnamed-chunk-7-1.png" alt="Movement data from a harbor seal in Alaska. Raw Argos observations and the derived connect-the-dots trackline" width="700"><p class="caption">
Movement data from a harbor seal in Alaska. Raw Argos observations and the derived connect-the-dots trackline
</p>
</div>
</div>
<div id="re-route-raw-observations" class="section level2">
<h2 class="hasAnchor">
<a href="#re-route-raw-observations" class="anchor"></a>Re-Route Raw Observations</h2>
<p>While the preferred approach would be to rely on a movement model for predicting the path of our seal, it can sometimes be useful to just correct the raw observations. So, that’s what we’ll do first.</p>
<div id="limit-barrier-polygon-to-region-of-interest" class="section level3">
<h3 class="hasAnchor">
<a href="#limit-barrier-polygon-to-region-of-interest" class="anchor"></a>Limit Barrier Polygon to Region of Interest</h3>
<p>With such a large geographic area, the computational time needed to create our visibility graph could be quite large. So, we will want to limit our land polygon as much as we reasonably can.</p>
<p>We’ll do this by creating a convex hull boundary around our observed data and limiting the region to this space. Here, we’ll go with a buffer of 50 km around each point and rely on the buffered features to create our convex hull. The size of the buffer is case-specific. In this case, we could likely get away with a smaller buffer if we were only interested in the connect-the-dot track or a model predication. But, later, we will also impute additional, possible tracks from the model fit to better represent model uncertainty. For this reason, we went with a larger buffer so we only have to create a single network graph.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">land_region</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">harborSeal_sf</span>, dist <span class="op">=</span> <span class="fl">50000</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_convex_hull</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">akcoast</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_collection_extract.html">st_collection_extract</a></span><span class="op">(</span><span class="st">'POLYGON'</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html">st_sf</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">annotation_spatial</a></span><span class="op">(</span><span class="va">land_region</span>, fill <span class="op">=</span> <span class="st">"cornsilk3"</span>, size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">l</span>, color <span class="op">=</span> <span class="st">"darkgrey"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">harborSeal_sf</span>, color <span class="op">=</span> <span class="st">"deepskyblue3"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="akharborseal_demo_files/figure-html/unnamed-chunk-9-1.png" alt="Land barrier polygon after limiting to a 50km buffered convex hull of the observation points" width="700"><p class="caption">
Land barrier polygon after limiting to a 50km buffered convex hull of the observation points
</p>
</div>
</div>
<div id="create-visibility-graph" class="section level3">
<h3 class="hasAnchor">
<a href="#create-visibility-graph" class="anchor"></a>Create Visibility Graph</h3>
<p>At this point, we are ready to create our visibility graph using the <code><a href="../reference/prt_visgraph.html">pathroutr::prt_visgraph()</a></code> function. We’ll keep <em>centroids = FALSE</em> in order to speed up the build. Adding additional centroids will increase the likelihood of linearity in the calculated shortest path. This is especially true when the shortest path crosses larger areas of open water. However, adding the additional centroids results in a very large increase in computational time (both in createion of the visual graph and in subesquent operations). There is likely little improvement in situations where the shortest path routing follows the coast. The default setting is <em>centroids=FALSE</em>. If a user chooses to set <em>centroids=TRUE</em>, we strongly encourage setting <em>centroid_limit</em> to a large value (default is <em>1e+07</em>).</p>
<p>NOTE: the following step will take approximately 30 minutes. Here, to save time, the code is not evaluated and we will load from package data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vis_graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prt_visgraph.html">prt_visgraph</a></span><span class="op">(</span><span class="va">land_region</span><span class="op">)</span>
<span class="co">#&gt; Warning in SpatialLinesNetwork.sf(edges): Graph composed of multiple subgraphs,</span>
<span class="co">#&gt; consider cleaning it with sln_clean_graph().</span></code></pre></div>
<p>Let’s take a look at our network. The ‘edges’ are stored within <code>@sl</code> slot of <code>vis_graph</code>. We can pass thing along to <code><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">ggspatial::layer_spatial()</a></code> just like an <code>sf</code> object.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">annotation_spatial</a></span><span class="op">(</span><span class="va">land_region</span>, fill <span class="op">=</span> <span class="st">"cornsilk3"</span>, size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">vis_graph</span><span class="op">@</span><span class="va">sl</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="akharborseal_demo_files/figure-html/unnamed-chunk-11-1.png" alt="Visibility graph network edges created with the `{stplanr}` package. All vertices from the land polygon were used as nodes in the network and any edges that crossed land were removed." width="700"><p class="caption">
Visibility graph network edges created with the <a href="https://docs.ropensci.org/stplanr">stplanr</a> package. All vertices from the land polygon were used as nodes in the network and any edges that crossed land were removed.
</p>
</div>
<p>Note the large triangles in the large, open water areas. This is a key advantage for our purpose as we concentrate the detail of our network along the coastline where routing of our tracks around land requires the most detail. The trade-off is that any shortest path routing that crosses the large, open areas will have less linearity. If we had set <em>centroids=FALSE</em>, then a centroid point would have been added to each of these triangles and the mesh would have been rebuild to include those points.</p>
</div>
<div id="determine-segments-of-track-on-land" class="section level3">
<h3 class="hasAnchor">
<a href="#determine-segments-of-track-on-land" class="anchor"></a>Determine Segments of Track On Land</h3>
<p>In this example, our interest is to re-route only the portions of the track that cross land. So, we need to identify the segments of consecutive points on land and, also, the points in water that bookend each segment. We will use this information to calculate our shortest path through our network and create an updated series of point features.</p>
<p>Since our bookend points were not used to create our visibility graph, we need to also determine the closes network node to each point.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">track_pts</span> <span class="op">&lt;-</span> <span class="va">harborSeal_sf</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_query.html">st_is_empty</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>
<span class="va">segs_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_barrier_segments.html">get_barrier_segments</a></span><span class="op">(</span><span class="va">track_pts</span>,<span class="va">land_region</span><span class="op">)</span>
<span class="va">segs_tbl</span> <span class="op">&lt;-</span> <span class="va">segs_tbl</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/prt_nearestnode.html">prt_nearestnode</a></span><span class="op">(</span><span class="va">vis_graph</span>, maxdist <span class="op">=</span> <span class="fl">50000</span><span class="op">)</span>
<span class="va">segs_tbl</span>
<span class="co">#&gt; # A tibble: 44 x 8</span>
<span class="co">#&gt;      sid start_idx end_idx n_pts                  start_pt</span>
<span class="co">#&gt;    &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;               &lt;POINT [m]&gt;</span>
<span class="co">#&gt;  1     1        70      72     1       (-7141.435 1009874)</span>
<span class="co">#&gt;  2     2       211     213     1        (17825.82 1009686)</span>
<span class="co">#&gt;  3     3       296     298     1      (-166514.5 678462.8)</span>
<span class="co">#&gt;  4     4       299     301     1      (-166385.8 678569.6)</span>
<span class="co">#&gt;  5     5       310     312     1        (-159772 672617.8)</span>
<span class="co">#&gt;  6     6       313     315     1      (-168417.8 679098.1)</span>
<span class="co">#&gt;  7     7       346     348     1      (-166934.5 680376.9)</span>
<span class="co">#&gt;  8     8       372     375     2        (-167836 679632.4)</span>
<span class="co">#&gt;  9     9       390     392     1        (-164953 673937.4)</span>
<span class="co">#&gt; 10    10       398     400     1        (-163341.9 680010)</span>
<span class="co">#&gt; # … with 34 more rows, and 3 more variables: end_pt &lt;POINT [m]&gt;,</span>
<span class="co">#&gt; #   start_node &lt;int&gt;, end_node &lt;int&gt;</span></code></pre></div>
</div>
<div id="determine-re-routed-track-via-shortest-path" class="section level3">
<h3 class="hasAnchor">
<a href="#determine-re-routed-track-via-shortest-path" class="anchor"></a>Determine Re-routed Track via Shortest Path</h3>
<p>Now, we have all the information we need to calculate the shortest path through our network for each segment. The <code><a href="https://docs.ropensci.org/stplanr/reference/sum_network_routes.html">stplanr::sum_network_routes()</a></code> function only calculates the LINESTRING from start node to end node. So, the <code><a href="../reference/prt_shortpath.html">prt_shortpath()</a></code> function extends each end to connect with our bookend points for each segment.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">segs_tbl</span> <span class="op">&lt;-</span> <span class="va">segs_tbl</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/prt_shortpath.html">prt_shortpath</a></span><span class="op">(</span><span class="va">vis_graph</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">annotation_spatial</a></span><span class="op">(</span><span class="va">land_region</span>, fill <span class="op">=</span> <span class="st">"cornsilk3"</span>, size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">segs_tbl</span><span class="op">$</span><span class="va">geometry</span>, color <span class="op">=</span> <span class="st">"deepskyblue3"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="akharborseal_demo_files/figure-html/unnamed-chunk-13-1.png" alt="Segments that were identified to cross land have been re-routed along the shortest path throught visibility network" width="700"><p class="caption">
Segments that were identified to cross land have been re-routed along the shortest path throught visibility network
</p>
</div>
</div>
<div id="update-geometry-with-re-routed-coordinates" class="section level3">
<h3 class="hasAnchor">
<a href="#update-geometry-with-re-routed-coordinates" class="anchor"></a>Update Geometry With Re-routed Coordinates</h3>
<p>This last bit is the point where we insert the fixed points back into our original path.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">track_pts_fix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prt_update_points.html">prt_update_points</a></span><span class="op">(</span><span class="va">track_pts</span>, <span class="va">segs_tbl</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">track_line_fixed</span> <span class="op">&lt;-</span> <span class="va">track_pts_fix</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>do_union <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="st">'LINESTRING'</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">annotation_spatial</a></span><span class="op">(</span><span class="va">land_region</span>, fill <span class="op">=</span> <span class="st">"cornsilk3"</span>, size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">track_line_fixed</span>, color <span class="op">=</span> <span class="st">"darkgrey"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">track_pts_fix</span>, color <span class="op">=</span> <span class="st">"deepskyblue3"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="akharborseal_demo_files/figure-html/unnamed-chunk-15-1.png" alt="Raw Argos observation geometries updated in place with the re-routed paths" width="700"><p class="caption">
Raw Argos observation geometries updated in place with the re-routed paths
</p>
</div>
</div>
</div>
<div id="re-routing-a-movement-model-prediction" class="section level2">
<h2 class="hasAnchor">
<a href="#re-routing-a-movement-model-prediction" class="anchor"></a>Re-Routing a Movement Model Prediction</h2>
<p>First, let’s fit our movement model. Here, we rely on an example from the <code>{crawl}</code> package. But, other model approaches (e.g. <code>{foieGras}</code>) should work as well. We have plans to provide specific methods for a variety of model outputs.</p>
<div id="fit-movement-model-and-predict-locations" class="section level3">
<h3 class="hasAnchor">
<a href="#fit-movement-model-and-predict-locations" class="anchor"></a>Fit Movement Model and Predict Locations</h3>
<p>As you might have noticed when we re-routed our raw observations, the trackline derived from those points can still cross land. This is because we only control for the presence of observation points on land. At the irregular and sometimes large time intervals common to location data for marine mammals, this cannot be avoided. However, once we have a movement model, we can predicted a finer location intervals and limit this possibility. You will notice in this example, the prediction interval is every 5 minutes.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">##Fit model as given in Johnson et al. (2008) Ecology 89:1208-1215</span>
<span class="co">## Start values for theta come from the estimates in Johnson et al. (2008)</span>
<span class="va">fixPar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">250</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1500</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fl">5</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/crawl/man/displayPar.html">displayPar</a></span><span class="op">(</span> mov.model<span class="op">=</span><span class="op">~</span><span class="fl">1</span>, err.model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x<span class="op">=</span><span class="op">~</span><span class="va">Argos_loc_class</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,data<span class="op">=</span><span class="va">harborSeal_sf</span>, 
            activity<span class="op">=</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">DryTime</span><span class="op">)</span>,fixPar<span class="op">=</span><span class="va">fixPar</span><span class="op">)</span>
<span class="co">#&gt;                  ParNames   fixPar thetaIdx</span>
<span class="co">#&gt; 1 ln tau Argos_loc_class0 5.521461       NA</span>
<span class="co">#&gt; 2 ln tau Argos_loc_class1 6.214608       NA</span>
<span class="co">#&gt; 3 ln tau Argos_loc_class2 7.313220       NA</span>
<span class="co">#&gt; 4 ln tau Argos_loc_class3       NA        1</span>
<span class="co">#&gt; 5 ln tau Argos_loc_classA       NA        2</span>
<span class="co">#&gt; 6 ln tau Argos_loc_classB       NA        3</span>
<span class="co">#&gt; 7    ln sigma (Intercept)       NA        4</span>
<span class="co">#&gt; 8     ln beta (Intercept)       NA        5</span>
<span class="co">#&gt; 9                  ln phi 0.000000       NA</span>
<span class="va">constr</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1500</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
  upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">Inf</span>,<span class="fl">5</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/crawl/man/crwMLE.html">crwMLE</a></span><span class="op">(</span>
  mov.model<span class="op">=</span><span class="op">~</span><span class="fl">1</span>, err.model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x<span class="op">=</span><span class="op">~</span><span class="va">Argos_loc_class</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, activity<span class="op">=</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">DryTime</span><span class="op">)</span>,
  data<span class="op">=</span><span class="va">harborSeal_sf</span>,  Time.name<span class="op">=</span><span class="st">"Time"</span>, 
  fixPar<span class="op">=</span><span class="va">fixPar</span>, theta<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">*</span><span class="fl">3600</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,
  constr<span class="op">=</span><span class="va">constr</span>, method<span class="op">=</span><span class="st">"L-BFGS-B"</span>,
  control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>maxit<span class="op">=</span><span class="fl">2000</span>, trace<span class="op">=</span><span class="fl">1</span>, REPORT<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; Beginning SANN initialization ...</span>
<span class="co">#&gt; Beginning likelihood optimization ...</span>
<span class="co">#&gt; iter    1 value 41202.609844</span>
<span class="co">#&gt; iter    2 value 41056.998394</span>
<span class="co">#&gt; iter    3 value 40756.499671</span>
<span class="co">#&gt; iter    4 value 40146.411888</span>
<span class="co">#&gt; iter    5 value 40066.268387</span>
<span class="co">#&gt; iter    6 value 40005.050127</span>
<span class="co">#&gt; iter    7 value 40001.092459</span>
<span class="co">#&gt; iter    8 value 40001.050325</span>
<span class="co">#&gt; iter    9 value 40001.048541</span>
<span class="co">#&gt; iter   10 value 40001.048534</span>
<span class="co">#&gt; final  value 40001.048534 </span>
<span class="co">#&gt; converged</span>

<span class="va">pred1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/crawl/man/crwPredict.html">crwPredict</a></span><span class="op">(</span><span class="va">fit1</span>, predTime <span class="op">=</span> <span class="st">'10 min'</span><span class="op">)</span>
<span class="va">pred1_sf</span> <span class="op">&lt;-</span> <span class="va">pred1</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/crawl/man/crw_as_sf.html">crw_as_sf</a></span><span class="op">(</span><span class="st">"POINT"</span>,<span class="st">"p"</span><span class="op">)</span></code></pre></div>
</div>
<div id="identify-predicted-locations-on-land" class="section level3">
<h3 class="hasAnchor">
<a href="#identify-predicted-locations-on-land" class="anchor"></a>Identify Predicted Locations on Land</h3>
<p>As before, we need to identify all of the segments of consecutive locations on land and determine the associated start and end nodes within our network.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">segs_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_barrier_segments.html">get_barrier_segments</a></span><span class="op">(</span><span class="va">pred1_sf</span>,<span class="va">land_region</span><span class="op">)</span>
<span class="va">segs_tbl</span> <span class="op">&lt;-</span> <span class="va">segs_tbl</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/prt_nearestnode.html">prt_nearestnode</a></span><span class="op">(</span><span class="va">vis_graph</span><span class="op">)</span>
<span class="va">segs_tbl</span>
<span class="co">#&gt; # A tibble: 147 x 8</span>
<span class="co">#&gt;      sid start_idx end_idx n_pts                  start_pt</span>
<span class="co">#&gt;    &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;               &lt;POINT [m]&gt;</span>
<span class="co">#&gt;  1     1      3639    3652    12        (16246.11 1008908)</span>
<span class="co">#&gt;  2     2      3723    3727     3        (13879.22 1009100)</span>
<span class="co">#&gt;  3     3      3728    3732     3        (14287.79 1007627)</span>
<span class="co">#&gt;  4     4      3732    3834   101         (14675.3 1006230)</span>
<span class="co">#&gt;  5     5      3972    3976     3       (46971.14 912298.8)</span>
<span class="co">#&gt;  6     6      3984    3992     7       (44466.22 904097.1)</span>
<span class="co">#&gt;  7     7      4889    4892     2      (-169612.5 678456.2)</span>
<span class="co">#&gt;  8     8      5286    5296     9      (-166915.1 673045.5)</span>
<span class="co">#&gt;  9     9      5317    5345    27      (-166337.5 678529.5)</span>
<span class="co">#&gt; 10    10      5415    5423     7      (-166152.1 678410.4)</span>
<span class="co">#&gt; # … with 137 more rows, and 3 more variables: end_pt &lt;POINT [m]&gt;,</span>
<span class="co">#&gt; #   start_node &lt;int&gt;, end_node &lt;int&gt;</span></code></pre></div>
</div>
<div id="re-route-model-prediction-via-shortest-path" class="section level3">
<h3 class="hasAnchor">
<a href="#re-route-model-prediction-via-shortest-path" class="anchor"></a>Re-route Model Prediction via Shortest Path</h3>
<p>As before, we use the <code><a href="../reference/prt_shortpath.html">prt_shortpath()</a></code> function to calculated all of our re-routed paths</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">segs_tbl</span> <span class="op">&lt;-</span> <span class="va">segs_tbl</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/prt_shortpath.html">prt_shortpath</a></span><span class="op">(</span><span class="va">vis_graph</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">annotation_spatial</a></span><span class="op">(</span><span class="va">land_region</span>, fill <span class="op">=</span> <span class="st">"cornsilk3"</span>, size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">segs_tbl</span><span class="op">$</span><span class="va">geometry</span>, color <span class="op">=</span> <span class="st">"deepskyblue3"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="akharborseal_demo_files/figure-html/unnamed-chunk-18-1.png" alt="Re-routed segments from the predicted path" width="700"><p class="caption">
Re-routed segments from the predicted path
</p>
</div>
</div>
<div id="update-predicted-path" class="section level3">
<h3 class="hasAnchor">
<a href="#update-predicted-path" class="anchor"></a>Update Predicted Path</h3>
<p>This last bit is the point where we insert the fixed points back into our original path. This is done by taking the number of points in the original segment and distributing an equal number of points along the updated path. At this time, the geometry is simply updated in place. This isn’t, technically, the correct approach as all of the model prediction parameters are no longer valid for these updated records. Expect this workflow/function/approach to change. But, for now, it allows us to demonstrate the issue and troubleshoot any issues.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">track_pts_fix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prt_update_points.html">prt_update_points</a></span><span class="op">(</span><span class="va">pred1_sf</span>, <span class="va">segs_tbl</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">track_line_fixed</span> <span class="op">&lt;-</span> <span class="va">track_pts_fix</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>do_union <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="st">'LINESTRING'</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">annotation_spatial</a></span><span class="op">(</span><span class="va">land_region</span>, fill <span class="op">=</span> <span class="st">"cornsilk3"</span>, size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">track_line_fixed</span>, color <span class="op">=</span> <span class="st">"deepskyblue3"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="akharborseal_demo_files/figure-html/unnamed-chunk-20-1.png" alt="Updated predicted path with re-routed geometries" width="700"><p class="caption">
Updated predicted path with re-routed geometries
</p>
</div>
</div>
</div>
<div id="multiple-imputation" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-imputation" class="anchor"></a>Multiple Imputation</h2>
<p>The recommended analytic workflow for <code>{crawl}</code> movement models is to characterize movement from a collection of imputed paths from the model fit. The <code>{pathroutr}</code> re-routing can be applied to each of these imputed paths and, hopefully, provide a more complete picture of uncertainty.</p>
<div id="create-multiple-imputations-from-crawl-model" class="section level3">
<h3 class="hasAnchor">
<a href="#create-multiple-imputations-from-crawl-model" class="anchor"></a>Create Multiple Imputations from {crawl} Model</h3>
<p>We will use the <code><a href="https://rdrr.io/pkg/crawl/man/crwPostIS.html">crawl::crwPostIS()</a></code> function to create our imputed paths.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">crw_sim</span> <span class="op">&lt;-</span> <span class="fu">crawl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/crawl/man/crwSimulator.html">crwSimulator</a></span><span class="op">(</span><span class="va">fit1</span>, predTime <span class="op">=</span> <span class="st">"10 min"</span><span class="op">)</span>
<span class="co">#&gt; Computing importance weights ...</span>



<span class="va">midf</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>.rows <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>postis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/crawl/man/crwPostIS.html">crwPostIS</a></span><span class="op">(</span><span class="va">crw_sim</span>, fullPost <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,
         pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/crawl/man/crw_as_sf.html">crw_as_sf</a></span><span class="op">(</span><span class="va">postis</span>, locType <span class="op">=</span> <span class="st">"p"</span>, ftype <span class="op">=</span> <span class="st">"POINT"</span><span class="op">)</span><span class="op">)</span>,
         lines <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/crawl/man/crw_as_sf.html">crw_as_sf</a></span><span class="op">(</span><span class="va">postis</span>, locType <span class="op">=</span> <span class="st">"p"</span>, ftype <span class="op">=</span> <span class="st">"LINESTRING"</span><span class="op">)</span><span class="op">)</span>,
         segs_tbl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_barrier_segments.html">get_barrier_segments</a></span><span class="op">(</span><span class="va">pts</span>, <span class="va">land_region</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                           <span class="fu"><a href="../reference/prt_nearestnode.html">prt_nearestnode</a></span><span class="op">(</span><span class="va">vis_graph</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                           <span class="fu"><a href="../reference/prt_shortpath.html">prt_shortpath</a></span><span class="op">(</span><span class="va">vis_graph</span><span class="op">)</span><span class="op">)</span>,
         pts_fix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/prt_update_points.html">prt_update_points</a></span><span class="op">(</span><span class="va">pts</span>, <span class="va">segs_tbl</span><span class="op">)</span><span class="op">)</span>,
         lines_fix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">pts_fix</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>do_union <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="st">'LINESTRING'</span><span class="op">)</span><span class="op">)</span>
         <span class="op">)</span>

<span class="va">sim_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">midf</span><span class="op">$</span><span class="va">lines_fix</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">annotation_spatial</a></span><span class="op">(</span><span class="va">land_region</span>, fill <span class="op">=</span> <span class="st">"cornsilk3"</span>, size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">sim_lines</span>, color <span class="op">=</span> <span class="st">"deepskyblue"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/layer_spatial.html">layer_spatial</a></span><span class="op">(</span><span class="va">track_line_fixed</span>, color <span class="op">=</span> <span class="st">"deepskyblue3"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="akharborseal_demo_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Josh London.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
